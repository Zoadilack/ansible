---
- name: Set the hostname in /etc/hostname
  shell: echo {{ hostname }} > /etc/hostname
  when: hostname is defined

- name: Set the hostname
  shell: hostname {{ hostname }}
  when: hostname is defined

- name: Update /etc/hosts
  lineinfile: dest=/etc/hosts regexp='^127\.0\.0\.1' line='127.0.0.1 localhost {{ hostname }}' owner=root group=root mode=0644

- name: make sure ssh config exists
  file: dest=/home/vagrant/.ssh/config state=touch mode=0644

- name: ensure github.com is a known host
  lineinfile:
    dest: /home/vagrant/.ssh/known_hosts
    create: yes
    state: present
    line: "{{ lookup('pipe', 'ssh-keyscan -t rsa github.com') }}"
    regexp: "^github\\.com"

- name: ensure bitbucket.org is a known host
  lineinfile:
    dest: /home/vagrant/.ssh/known_hosts
    create: yes
    state: present
    line: "{{ lookup('pipe', 'ssh-keyscan -t rsa bitbucket.org') }}"
    regexp: "^bitbucket\\.org"

- name: for vagrant, do not strict host bitbucket
  command: echo -e "Host bitbucket.org\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config

- name: for vagrant, do not strict host github
  command: echo -e "Host github.com\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config

- name: make ssl dir
  file: dest=/etc/nginx/ssl state=directory mode=0755 owner=www-data group=www-data

- name: create self-signed SSL cert
  command: openssl req -new -nodes -x509 -subj "/C=US/ST=Washington/L=Seattle/O=IT/CN=${ansible_fqdn}" -days 3650 -keyout /etc/nginx/ssl/{{appname}}.key -out /etc/nginx/ssl/{{appname}}.crt -extensions v3_ca creates=/etc/nginx/ssl/{{appname}}.crt

- stat: path=/var/swapfile
  register: swapfile

# @TODO: automate this with Ansible instead of a shell script
- name: create swapfile
  shell: bash /var/www/{{appname}}/provisioning/misc/scripts/swapfile.sh
  when: swapfile.stat.exists == False

- name: install the api
  command: composer install --prefer-dist -o -vvv
  become: false
  args:
    chdir: "/var/www/{{appname}}/api"


